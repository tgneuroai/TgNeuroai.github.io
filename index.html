<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NEURO AI Mining App</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@tonconnect/sdk@latest/dist/tonconnect-sdk.min.js"></script>
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import { getFirestore } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
    import { getDatabase } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';
    const firebaseConfig = {
      apiKey: "AIzaSyA0AXNFqkyr1KbWOv0mtHemU1fGsQIStHU",
      authDomain: "tgneuroai.firebaseapp.com",
      projectId: "tgneuroai",
      storageBucket: "tgneuroai.firebasestorage.app",
      messagingSenderId: "681917491498",
      appId: "1:681917491498:web:3e99a66a721f152dbb1653"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const rtdb = getDatabase(app);
    window.firebase = { db, rtdb };
  </script>
  <style>
    .nft-card, .referral-card, .task-card {
      position: relative;
      overflow: hidden;
    }
    .nft-card::before, .referral-card::before, .task-card::before {
      content: '';
      position: absolute;
      inset: -2px;
      background: linear-gradient(45deg, #a855f7, #3b82f6, #a855f7);
      z-index: -1;
      animation: rotateBorder 3s linear infinite;
    }
    @keyframes rotateBorder {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .section {
      animation: fadeIn 0.3s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .nav-button:hover {
      filter: drop-shadow(0 0 8px rgba(168, 85, 247, 0.7));
      transform: scale(1.05);
    }
    .nav-button.active {
      border-bottom: 2px solid #a855f7;
      filter: drop-shadow(0 0 10px rgba(168, 85, 247, 0.9));
    }
  </style>
</head>
<body class="bg-gray-950 text-white font-sans m-0 overflow-x-hidden">

  <!-- Wallet / Header Card -->
  <div class="bg-gradient-to-r from-purple-600 to-indigo-600 p-4 rounded-b-3xl shadow-lg text-center">
    <div class="flex items-center justify-center space-x-3">
      <img src="https://via.placeholder.com/40" alt="NAI Logo" class="w-10 h-10 rounded-full" />
      <h1 class="text-2xl font-bold tracking-wide">NEURO AI</h1>
    </div>
    <p class="mt-2 text-sm text-gray-200">Balance:</p>
    <h2 id="user-balance" class="text-3xl font-bold">0 <span class="text-yellow-300">NAI</span></h2>
    <p id="wallet-address" class="mt-2 text-sm text-gray-300 hidden">Wallet: <span id="address-text">Not Connected</span></p>
    <button id="connect-wallet" class="mt-3 bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 px-4 py-2 rounded-full font-bold text-white transition">Connect Wallet</button>
  </div>

  <!-- Bottom Navigation -->
  <div class="fixed bottom-0 w-full bg-white flex justify-around py-4 border-t border-gray-300 z-50 text-xs rounded-t-xl">
    <button onclick="showSection('home')" class="nav-button flex flex-col items-center transition text-gray-900" id="nav-home">
      <img src="https://cdn-icons-png.flaticon.com/512/1946/1946436.png" class="w-8 h-8 mb-1" />
      <span class="font-semibold uppercase">Home</span>
    </button>
    <button onclick="showSection('mining')" class="nav-button flex flex-col items-center transition text-gray-900" id="nav-mining">
      <img src="https://cdn-icons-png.flaticon.com/512/2910/2910761.png" class="w-8 h-8 mb-1" />
      <span class="font-semibold uppercase">Mining</span>
    </button>
    <button onclick="showSection('referral')" class="nav-button flex flex-col items-center transition text-gray-900" id="nav-referral">
      <img src="https://cdn-icons-png.flaticon.com/512/1077/1077114.png" class="w-8 h-8 mb-1" />
      <span class="font-semibold uppercase">Referral</span>
    </button>
    <button onclick="showSection('tasks')" class="nav-button flex flex-col items-center transition text-gray-900" id="nav-tasks">
      <img src="https://cdn-icons-png.flaticon.com/512/1828/1828911.png" class="w-8 h-8 mb-1" />
      <span class="font-semibold uppercase">Tasks</span>
    </button>
    <button onclick="showSection('leaderboard')" class="nav-button flex flex-col items-center transition text-gray-900" id="nav-leaderboard">
      <img src="https://iili.io/FHHLkLQ.png" class="w-8 h-8 mb-1" />
      <span class="font-semibold uppercase">Top</span>
    </button>
  </div>

  <!-- Main Content -->
  <div id="content" class="p-4 pb-24 space-y-8 rounded-t-2xl bg-gray-950">

    <!-- HOME SECTION -->
    <div id="home" class="section space-y-6">
      <h2 class="text-xl font-semibold">🏠 Dashboard</h2>
      <div class="bg-gray-800 p-4 rounded-xl text-center shadow relative overflow-hidden"
           style="background-image: url('https://iili.io/FIkdc3x.gif'); background-size: cover; background-position: center;">
        <div class="bg-black bg-opacity-60 p-6 rounded-xl">
          <button onclick="showSection('mining')" class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded-full font-bold text-white transition">Start Mining</button>
        </div>
      </div>
      <div class="bg-gray-800 p-4 rounded-xl">
        <h3 class="font-semibold mb-2">🎁 NFTs</h3>
        <ul id="nft-preview" class="space-y-1 text-sm"></ul>
        <button onclick="showSection('mining')" class="mt-2 text-sm text-blue-400 underline">View All</button>
      </div>
      <div class="bg-gray-800 p-4 rounded-xl">
        <h3 class="font-semibold mb-2">👥 Referral Bonus</h3>
        <p class="text-sm text-gray-400">Earn up to 3 levels bonus</p>
        <button onclick="showSection('referral')" class="mt-2 text-sm text-blue-400 underline">Referral Details</button>
      </div>
      <div class="bg-gray-800 p-4 rounded-xl">
        <h3 class="font-semibold mb-2">📋 Tasks</h3>
        <ul id="task-preview" class="text-sm text-gray-300"></ul>
        <button onclick="showSection('tasks')" class="mt-2 text-sm text-blue-400 underline">View All</button>
      </div>
      <div class="bg-gray-800 p-4 rounded-xl">
        <h3 class="font-semibold mb-2">🏆 Top Miners</h3>
        <p id="leaderboard-preview">Loading...</p>
        <button onclick="showSection('leaderboard')" class="mt-2 text-sm text-blue-400 underline">View Full</button>
      </div>
    </div>

    <!-- MINING SECTION -->
    <div id="mining" class="section hidden space-y-6">
      <h2 class="text-xl font-semibold">⚒️ Start Mining</h2>
      <div id="mining-card" class="relative rounded-xl overflow-hidden text-center shadow-inner"
           style="background-image: url('https://iili.io/FIkdc3x.gif'); background-size: cover; background-position: center;">
        <div class="bg-black bg-opacity-60 p-6">
          <button onclick="showSection('nft-selection')" class="bg-green-500 hover:bg-green-600 transition px-4 py-2 rounded-full text-white font-bold">
            Start Mining
          </button>
          <div id="mining-info">
            <p class="mt-3 text-sm text-gray-100">Your Mining Power: <strong>Loading...</strong></p>
            <p class="text-sm text-gray-100">Total Mined: <strong>Loading...</strong></p>
          </div>
        </div>
      </div>
      <div id="nft-selection" class="section hidden space-y-6">
        <h2 class="text-xl font-semibold">🎁 Select NFT for Mining</h2>
        <div id="nft-list" class="space-y-4"></div>
        <button onclick="showSection('mining')" class="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded-full font-bold text-white transition">Back to Mining</button>
      </div>
      <div>
        <h2 class="text-lg font-semibold mt-6 mb-2">🎁 Your NFTs</h2>
        <div id="your-nfts" class="space-y-4"></div>
      </div>
    </div>

    <!-- REFERRAL SECTION -->
    <div id="referral" class="section hidden space-y-6">
      <h2 class="text-xl font-semibold">👥 Referral Program</h2>
      <div class="bg-gray-800 p-4 rounded-xl">
        <p class="text-sm text-gray-300">Your Referral Link:</p>
        <input id="referral-link" class="mt-2 w-full p-2 bg-gray-700 rounded text-white" readonly value="Generating..." />
        <button onclick="copyReferralLink()" class="mt-2 bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded-full font-bold text-white transition">Copy Link</button>
      </div>
      <h3 class="text-lg font-semibold mt-6 mb-2">📊 Referral Stats</h3>
      <div id="referral-stats" class="space-y-2"></div>
    </div>

    <!-- TASKS SECTION -->
    <div id="tasks" class="section hidden space-y-6">
      <h2 class="text-xl font-semibold">📋 Daily Tasks</h2>
      <div id="task-list" class="space-y-3"></div>
    </div>

    <!-- LEADERBOARD SECTION -->
    <div id="leaderboard" class="section hidden space-y-6">
      <h2 class="text-xl font-semibold">🏆 Leaderboard</h2>
      <p id="user-rank" class="text-sm text-gray-300">Your Rank: Loading...</p>
      <h3 class="text-lg font-semibold">Top 50 Miners</h3>
      <div id="miners-leaderboard"></div>
    </div>
  </div>

  <!-- JavaScript -->
  <script type="module">
    import { doc, getDoc, setDoc, updateDoc, collection, getDocs } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
    import { ref, onValue } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';

    const { db, rtdb } = window.firebase;
    let userNFTs = [
      { url: 'https://iili.io/FIkdc3x.gif', name: 'NFT #1 - Free', icon: '🎖️', hashRate: 15 },
      { url: 'https://iili.io/FIkdhGa.gif', name: 'NFT #2 - 5 TON', icon: '🥇', hashRate: 20 },
      { url: 'https://iili.io/FIkdj6J.gif', name: 'NFT #3 - 12 TON', icon: '🥈', hashRate: 25 },
      { url: 'https://iili.io/FIkdSjt.gif', name: 'NFT #4 - 25 TON', icon: '🥉', hashRate: 30 },
      { url: 'https://iili.io/FIkdXCg.gif', name: 'NFT #5 - 50 TON', icon: '🏆', hashRate: 50 },
    ];
    let selectedNFT = userNFTs[0].url;
    let userAddress = null;

    // Section Switch
    function showSection(id) {
      ['home', 'mining', 'referral', 'tasks', 'leaderboard', 'nft-selection'].forEach(section => {
        document.getElementById(section).classList.add('hidden');
        const navButton = document.getElementById(`nav-${section}`);
        if (navButton) navButton.classList.remove('active');
      });
      document.getElementById(id).classList.remove('hidden');
      const navButton = document.getElementById(`nav-${id}`);
      if (navButton) navButton.classList.add('active');
      if (id === 'mining') {
        document.getElementById('mining-card').style.backgroundImage = `url('${selectedNFT}')`;
        loadMiningStats();
      }
      if (id === 'referral') loadReferralData();
      if (id === 'nft-selection') loadNFTList();
      if (id === 'tasks') loadTasks();
      if (id === 'leaderboard') loadLeaderboards();
      if (id === 'home') loadHomeData();
    }

    // Load Home Data
    async function loadHomeData() {
      if (!userAddress) return;
      const userDoc = await getDoc(doc(db, 'users', userAddress));
      const user = userDoc.data() || { balance: 0, nfts: [userNFTs[0].url] };
      document.getElementById('user-balance').innerHTML = `${user.balance.toFixed(2)} <span class="text-yellow-300">NAI</span>`;
      document.getElementById('nft-preview').innerHTML = user.nfts.slice(0, 2).map(url => {
        const nft = userNFTs.find(n => n.url === url);
        return `<li class="flex justify-between">${nft.icon} ${nft.name} - <span>${nft.name.includes('Free') ? 'Free' : nft.name.split('-')[1]}</span></li>`;
      }).join('');
      document.getElementById('task-preview').innerHTML = tasks.map(task => `
        <li>${task.icon} ${task.name} - <span class="text-green-400">+${task.reward} NAI</span></li>
      `).join('');
      const leaderboardRef = ref(rtdb, 'leaderboard');
      onValue(leaderboardRef, snapshot => {
        const data = snapshot.val();
        document.getElementById('leaderboard-preview').innerHTML = Object.values(data).slice(0, 1).map((u, i) => `
          🥇 ${u.walletAddress.slice(0, 4)}...${u.walletAddress.slice(-4)} - ${u.balance.toFixed(2)} NAI
        `).join('');
      });
    }

    // Load Referral Data
    async function loadReferralData() {
      if (!userAddress) return;
      const userDoc = await getDoc(doc(db, 'users', userAddress));
      let user = userDoc.data();
      if (!user) {
        user = { walletAddress: userAddress, referralCode: Math.random().toString(36).substring(2, 8), balance: 0, nfts: [userNFTs[0].url], tasksCompleted: [] };
        await setDoc(doc(db, 'users', userAddress), user);
      }
      document.getElementById('referral-link').value = `https://neuroai.com?ref=${user.referralCode}`;
      const referrals = await getDocs(collection(db, 'referrals'));
      const userReferrals = referrals.docs.filter(doc => doc.data().referrer === userAddress);
      const totalCommission = userReferrals.reduce((sum, doc) => sum + doc.data().commission, 0);
      document.getElementById('referral-stats').innerHTML = `
        <div class="referral-card bg-gray-800 py-2 px-3 rounded-lg flex justify-between items-center text-sm hover:shadow-lg hover:shadow-purple-500/50 transition-shadow">
          <span class="font-semibold">Total Referrals</span>
          <span>${userReferrals.length}</span>
          <span>${totalCommission.toFixed(2)} NAI</span>
        </div>
      `;
    }

    // Copy Referral Link
    function copyReferralLink() {
      const link = document.getElementById('referral-link');
      link.select();
      document.execCommand('copy');
      alert('Link copied!');
    }

    // Load NFT List
    async function loadNFTList() {
      if (!userAddress) return;
      const userDoc = await getDoc(doc(db, 'users', userAddress));
      const user = userDoc.data() || { nfts: [userNFTs[0].url] };
      document.getElementById('nft-list').innerHTML = user.nfts.map(url => {
        const nft = userNFTs.find(n => n.url === url) || userNFTs[0];
        return `
          <div class="nft-card bg-gray-800 p-3 rounded-lg flex items-center space-x-4 hover:shadow-lg hover:shadow-purple-500/50 transition-shadow" onclick="selectNFT('${nft.url}')">
            <img src="${nft.url}" alt="${nft.name}" class="w-16 h-16 rounded-md border border-purple-500" />
            <div class="flex-1">
              <span class="text-sm font-semibold">${nft.icon} ${nft.name}</span>
            </div>
          </div>
        `;
      }).join('');
      document.getElementById('your-nfts').innerHTML = userNFTs.map(nft => `
        <div class="nft-card bg-gray-800 p-3 rounded-lg flex items-center space-x-4 hover:shadow-lg hover:shadow-purple-500/50 transition-shadow">
          <img src="${nft.url}" alt="${nft.name}" class="w-16 h-16 rounded-md border border-purple-500" />
          <div class="flex-1">
            <span class="text-sm font-semibold">${nft.icon} ${nft.name}</span>
          </div>
          <button onclick="buyNFT('${nft.url}')" class="bg-${nft.name.includes('Free') ? 'blue-500' : 'yellow-500'} text-${nft.name.includes('Free') ? 'white' : 'black'} px-3 py-1 rounded hover:bg-${nft.name.includes('Free') ? 'blue-600' : 'yellow-600'} transition">${nft.name.includes('Free') ? 'Claim' : 'Buy'}</button>
        </div>
      `).join('');
    }

    // Buy/Claim NFT
    async function buyNFT(url) {
      if (!userAddress) return alert('Please connect wallet');
      const userDoc = await getDoc(doc(db, 'users', userAddress));
      let user = userDoc.data();
      const nft = userNFTs.find(n => n.url === url);
      if (user.nfts.includes(url)) return alert('NFT already owned');
      if (nft.name.includes('Free')) {
        user.nfts.push(url);
        await updateDoc(doc(db, 'users', userAddress), { nfts: user.nfts });
        alert('NFT claimed!');
      } else {
        alert('Buy functionality coming soon!');
      }
      loadNFTList();
    }

    // Select NFT
    async function selectNFT(url) {
      if (!userAddress) return;
      selectedNFT = url;
      const nft = userNFTs.find(n => n.url === url) || userNFTs[0];
      await updateDoc(doc(db, 'mining', userAddress), {
        user: userAddress,
        nft: url,
        hashRate: nft.hashRate,
        lastUpdated: new Date().toISOString(),
      });
      showSection('mining');
    }

    // Load Mining Stats
    async function loadMiningStats() {
      if (!userAddress) return;
      const miningDoc = await getDoc(doc(db, 'mining', userAddress));
      let mining = miningDoc.data();
      if (!mining) {
        mining = { user: userAddress, nft: userNFTs[0].url, hashRate: userNFTs[0].hashRate, tokensMined: 0, lastUpdated: new Date().toISOString() };
        await setDoc(doc(db, 'mining', userAddress), mining);
      }
      const elapsed = (Date.now() - new Date(mining.lastUpdated)) / 1000;
      const tokensMined = mining.hashRate * elapsed * 0.0001;
      mining.tokensMined += tokensMined;
      mining.lastUpdated = new Date().toISOString();
      await updateDoc(doc(db, 'mining', userAddress), mining);
      const userDoc = await getDoc(doc(db, 'users', userAddress));
      let user = userDoc.data();
      user.balance += tokensMined;
      await updateDoc(doc(db, 'users', userAddress), { balance: user.balance });
      document.getElementById('mining-info').innerHTML = `
        <p class="mt-3 text-sm text-gray-100">Your Mining Power: <strong>${mining.hashRate} Hash/s</strong></p>
        <p class="text-sm text-gray-100">Total Mined: <strong>${mining.tokensMined.toFixed(2)} NAI</strong></p>
      `;
      document.getElementById('user-balance').innerHTML = `${user.balance.toFixed(2)} <span class="text-yellow-300">NAI</span>`;
    }

    // Tasks
    const tasks = [
      { id: 'telegram', name: 'Join Telegram', icon: '✅', reward: 10, link: 'https://t.me/neuroai' },
      { id: 'twitter', name: 'Follow Twitter', icon: '✅', reward: 5, link: 'https://twitter.com/neuroai' },
      { id: 'share', name: 'Share Link', icon: '✅', reward: 3, link: '' },
    ];

    async function loadTasks() {
      if (!userAddress) return;
      const userDoc = await getDoc(doc(db, 'users', userAddress));
      const user = userDoc.data() || { tasksCompleted: [] };
      document.getElementById('task-list').innerHTML = tasks.map(task => `
        <div class="task-card bg-gray-800 p-3 rounded-lg flex justify-between items-center hover:shadow-lg hover:shadow-purple-500/50 transition-shadow">
          <span>${task.icon} ${task.name} - <span class="text-green-400">+${task.reward} NAI</span></span>
          <button onclick="completeTask('${task.id}')" class="bg-blue-500 hover:bg-blue-600 px-3 py-1 rounded text-white transition ${user.tasksCompleted.includes(task.id) ? 'opacity-50 cursor-not-allowed' : ''}" ${user.tasksCompleted.includes(task.id) ? 'disabled' : ''}>
            ${user.tasksCompleted.includes(task.id) ? 'Completed' : 'Complete'}
          </button>
        </div>
      `).join('');
    }

    async function completeTask(taskId) {
      if (!userAddress) return alert('Please connect wallet');
      const userDoc = await getDoc(doc(db, 'users', userAddress));
      let user = userDoc.data();
      if (user.tasksCompleted.includes(taskId)) return;
      const task = tasks.find(t => t.id === taskId);
      if (task.link) window.open(task.link, '_blank');
      user.tasksCompleted.push(taskId);
      user.balance += task.reward;
      await updateDoc(doc(db, 'users', userAddress), { tasksCompleted: user.tasksCompleted, balance: user.balance });
      loadTasks();
      loadHomeData();
    }

    // Load Leaderboards
    async function loadLeaderboards() {
      if (!userAddress) return;
      const leaderboardRef = ref(rtdb, 'leaderboard');
      onValue(leaderboardRef, async snapshot => {
        const data = snapshot.val();
        const users = Object.values(data).sort((a, b) => b.balance - a.balance);
        const userRank = users.findIndex(u => u.walletAddress === userAddress) + 1;
        document.getElementById('user-rank').innerHTML = `Your Rank: ${userRank || 'Not ranked'}`;
        document.getElementById('miners-leaderboard').innerHTML = users.slice(0, 50).map((u, i) => `
          <div class="bg-${i < 3 ? 'gradient-to-r from-purple-600 to-blue-600' : 'gray-800'} p-3 rounded ${i < 3 ? 'text-base font-semibold shadow-lg shadow-purple-500/50' : ''}">
            ${i < 3 ? ['🥇', '🥈', '🥉'][i] : `${i+1}.`} ${u.walletAddress.slice(0, 4)}...${u.walletAddress.slice(-4)} - ${u.balance.toFixed(2)} NAI
          </div>
        `).join('');
      });
    }

    // TON Connect
    const tonConnect = new TonConnect({
      manifestUrl: 'https://your-manifest-url/tonconnect-manifest.json',
    });
    document.getElementById('connect-wallet').addEventListener('click', async () => {
      try {
        await tonConnect.connect({
          jsons: [
            { name: 'tonkeeper', url: 'https://app.tonkeeper.com/ton-connect' },
            { name: 'mytonwallet', url: 'https://mytonwallet.io/ton-connect' },
          ],
        });
        const walletInfo = await tonConnect.getWallet();
        if (walletInfo) {
          userAddress = walletInfo.account.address;
          document.getElementById('wallet-address').classList.remove('hidden');
          document.getElementById('address-text').textContent = `${userAddress.slice(0, 4)}...${userAddress.slice(-4)}`;
          document.getElementById('connect-wallet').textContent = 'Connected';
          document.getElementById('connect-wallet').classList.add('bg-green-500', 'hover:bg-green-600');
          document.getElementById('connect-wallet').classList.remove('bg-gradient-to-r', 'from-blue-500', 'to-purple-500', 'hover:from-blue-600', 'hover:to-purple-600');
          // Initialize user in Firestore
          const userDoc = await getDoc(doc(db, 'users', userAddress));
          if (!userDoc.exists()) {
            await setDoc(doc(db, 'users', userAddress), {
              walletAddress: userAddress,
              referralCode: Math.random().toString(36).substring(2, 8),
              balance: 0,
              nfts: [userNFTs[0].url],
              tasksCompleted: [],
            });
          }
          // Update leaderboard in Realtime Database
          await updateDoc(doc(db, 'users', userAddress), { lastActive: new Date().toISOString() });
          const user = (await getDoc(doc(db, 'users', userAddress))).data();
          set(ref(rtdb, `leaderboard/${userAddress}`), {
            walletAddress: userAddress,
            balance: user.balance,
          });
          loadHomeData();
          loadReferralData();
          loadNFTList();
          loadTasks();
          loadLeaderboards();
          loadMiningStats();
          // Auto-update leaderboard every 10 minutes
          setInterval(loadLeaderboards, 10 * 60 * 1000);
        }
      } catch (error) {
        console.error('Wallet connection failed:', error);
        alert('Failed to connect wallet. Please try again.');
      }
    });

    // Initial Load
    showSection('home');
  </script>
</body>
</html>